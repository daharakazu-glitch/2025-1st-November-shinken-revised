<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025年度 11月 進研模試 高1 英語 重要語句復習アプリ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Inter"', '"Noto Sans JP"', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                        }
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'glow': '0 0 15px rgba(14, 165, 233, 0.3)',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
        }
        .card {
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.01);
            padding: 32px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s ease;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: 0.025em;
        }
        .btn:active {
            transform: scale(0.98);
        }
        .btn-primary {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(14, 165, 233, 0.3);
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #38bdf8 0%, #0ea5e9 100%);
            box-shadow: 0 10px 15px -3px rgba(14, 165, 233, 0.4);
            transform: translateY(-1px);
        }
        .btn-secondary {
            background-color: white;
            color: #475569;
            border: 1px solid #e2e8f0;
        }
         .btn-secondary:hover {
            background-color: #f8fafc;
            border-color: #cbd5e1;
            color: #1e293b;
        }
        .btn-green {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3);
        }
        .btn-green:hover {
            background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
            box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.4);
            transform: translateY(-1px);
        }
        .btn-red {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.3);
        }
        .btn-red:hover {
            background: linear-gradient(135deg, #f87171 0%, #ef4444 100%);
            box-shadow: 0 10px 15px -3px rgba(239, 68, 68, 0.4);
        }
        .btn-orange {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(249, 115, 22, 0.3);
        }
        .btn-orange:hover {
            background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
            box-shadow: 0 10px 15px -3px rgba(249, 115, 22, 0.4);
            transform: translateY(-1px);
        }
        .btn-disabled {
            background: #cbd5e1;
            color: #94a3b8;
            cursor: not-allowed;
            box-shadow: none;
        }
        .btn-disabled:hover {
            background: #cbd5e1;
            transform: none;
        }
        .hidden {
            display: none !important;
        }
        .quiz-option {
            border: 2px solid #f1f5f9;
            padding: 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }
        .quiz-option:hover {
            border-color: #0ea5e9;
            background-color: #f0f9ff;
            transform: translateY(-1px);
        }
        .quiz-option.selected {
            border-color: #0ea5e9;
            background-color: #e0f2fe;
        }
        .quiz-option.correct {
            border-color: #10b981;
            background-color: #d1fae5;
            color: #065f46;
        }
        .quiz-option.incorrect {
            border-color: #ef4444;
            background-color: #fee2e2;
            color: #991b1b;
        }
        #mic-icon.recording {
            animation: pulse 1.5s infinite;
            color: white;
        }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .pronunciation-feedback {
            font-size: 1.25rem;
            font-weight: bold;
            margin-top: 1.5rem;
            min-height: 60px;
            padding: 10px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .feedback-perfect { color: #059669; background: #d1fae5; border: 1px solid #10b981; }
        .feedback-good { color: #0ea5e9; background: #e0f2fe; border: 1px solid #0ea5e9; }
        .feedback-ok { color: #d97706; background: #fef3c7; border: 1px solid #f59e0b; }
        .feedback-retry { color: #dc2626; background: #fee2e2; border: 1px solid #ef4444; }
        
        /* Flashcard Styles */
        .flashcard-container {
            perspective: 1000px;
        }
        .flashcard-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .flashcard-container.flipped .flashcard-inner {
            transform: rotateY(180deg);
        }
        .flashcard-front, .flashcard-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            border-radius: 16px;
        }
        .flashcard-back {
            transform: rotateY(180deg);
        }
        /* Image Loading Shimmer */
        .shimmer {
            background: #f6f7f8;
            background-image: linear-gradient(to right, #f6f7f8 0%, #edeef1 20%, #f6f7f8 40%, #f6f7f8 100%);
            background-repeat: no-repeat;
            background-size: 800px 104px; 
            display: inline-block;
            position: relative; 
            animation-duration: 1s;
            animation-fill-mode: forwards; 
            animation-iteration-count: infinite;
            animation-name: placeholderShimmer;
            animation-timing-function: linear;
        }
        @keyframes placeholderShimmer {
            0% { background-position: -468px 0; }
            100% { background-position: 468px 0; }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
    </style>
</head>
<body class="text-slate-800 antialiased">

    <div id="app" class="max-w-4xl mx-auto p-4 sm:p-8">
        <header class="text-center mb-10">
            <div class="inline-block p-2 bg-white rounded-2xl shadow-sm mb-4">
                <span class="px-3 py-1 bg-brand-100 text-brand-600 rounded-lg text-xs font-bold tracking-wider uppercase">Study App</span>
            </div>
            <h1 class="text-2xl sm:text-3xl md:text-4xl font-extrabold text-slate-900 tracking-tight leading-tight">
                <span class="text-brand-600">2025年度 11月 進研模試</span><br>
                英語 重要語句復習
            </h1>
        </header>

        <!-- Setup Section -->
        <section id="setup-section" class="card space-y-8 animate-fade-in">
            <div>
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-slate-800 flex items-center">
                        <span class="flex items-center justify-center w-8 h-8 rounded-full bg-brand-100 text-brand-600 text-sm mr-3">1</span>
                        学習する単語を選択
                    </h2>
                    <div class="flex space-x-2">
                        <button id="select-all" class="text-xs font-medium text-brand-600 hover:text-brand-700 hover:bg-brand-50 px-3 py-1.5 rounded-lg transition">すべて選択</button>
                        <button id="deselect-all" class="text-xs font-medium text-slate-500 hover:text-slate-700 hover:bg-slate-100 px-3 py-1.5 rounded-lg transition">すべて解除</button>
                    </div>
                </div>
                <div id="word-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3 max-h-80 overflow-y-auto p-4 bg-slate-50 border border-slate-200 rounded-xl">
                    <!-- Word checkboxes will be inserted here -->
                </div>
            </div>

            <div>
                <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center">
                    <span class="flex items-center justify-center w-8 h-8 rounded-full bg-brand-100 text-brand-600 text-sm mr-3">2</span>
                    学習モードを選択
                </h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <label class="relative flex items-center p-4 border border-slate-200 rounded-xl cursor-pointer hover:bg-slate-50 hover:border-brand-300 transition-all group">
                        <input type="radio" name="mode" value="word" class="peer sr-only" checked>
                        <div class="w-5 h-5 border-2 border-slate-300 rounded-full mr-3 peer-checked:border-brand-500 peer-checked:bg-brand-500 relative"></div>
                        <div class="flex flex-col">
                            <span class="font-bold text-slate-700 peer-checked:text-brand-700">単語・フレーズのみ</span>
                            <span class="text-xs text-slate-500 mt-1">基本的な意味を覚える</span>
                        </div>
                        <div class="absolute inset-0 border-2 border-transparent peer-checked:border-brand-500 rounded-xl pointer-events-none"></div>
                    </label>
                    <label class="relative flex items-center p-4 border border-slate-200 rounded-xl cursor-pointer hover:bg-slate-50 hover:border-brand-300 transition-all group">
                        <input type="radio" name="mode" value="sentence" class="peer sr-only">
                        <div class="w-5 h-5 border-2 border-slate-300 rounded-full mr-3 peer-checked:border-brand-500 peer-checked:bg-brand-500 relative"></div>
                        <div class="flex flex-col">
                            <span class="font-bold text-slate-700 peer-checked:text-brand-700">例文で学習</span>
                            <span class="text-xs text-slate-500 mt-1">AI生成イラスト付き</span>
                        </div>
                        <div class="absolute inset-0 border-2 border-transparent peer-checked:border-brand-500 rounded-xl pointer-events-none"></div>
                    </label>
                </div>
            </div>

            <div class="pt-4 flex flex-col sm:flex-row gap-4 justify-center items-center border-t border-slate-100">
                <button id="start-learning-btn" class="btn btn-primary w-full sm:w-auto text-lg min-w-[200px]">
                    <i class="fas fa-play mr-2 text-sm"></i> 学習を開始
                </button>
                <button id="quick-test-btn" class="btn btn-orange w-full sm:w-auto text-lg">
                    <i class="fas fa-random mr-2"></i> ランダムテスト
                </button>
                <button id="download-pdf-btn" class="btn btn-green w-full sm:w-auto text-lg">
                    <i class="fas fa-file-pdf mr-2 text-white"></i> PDF作成
                </button>
            </div>
        </section>

        <!-- Learning Section -->
        <section id="learning-section" class="card hidden flex flex-col h-auto min-h-[700px]">
            <div class="flex justify-between items-center mb-6">
                 <button id="back-to-setup-btn" class="text-sm text-slate-500 hover:text-slate-800 flex items-center transition">
                    <i class="fas fa-arrow-left mr-2"></i> 戻る
                </button>
                <div class="bg-slate-100 px-4 py-1.5 rounded-full">
                    <span id="progress-indicator" class="text-sm font-bold text-slate-600 font-mono"></span>
                </div>
                <div class="w-16"></div> <!-- Spacer for alignment -->
            </div>
            
            <div class="flex-grow flex flex-col justify-center mb-8">
                <div id="flashcard-container" class="relative w-full min-h-[400px] cursor-pointer group perspective-1000">
                    <!-- Flashcard Content -->
                    <div class="absolute inset-0 bg-white rounded-2xl border-2 border-slate-100 shadow-sm group-hover:shadow-md group-hover:border-brand-200 transition-all duration-300 flex flex-col items-center justify-center p-6 text-center overflow-hidden">
                        <div class="w-full flex flex-col items-center">
                            <!-- Illustration Area (Only visible in Sentence Mode) -->
                            <div id="illustration-area" class="hidden w-full max-w-md h-48 mb-6 rounded-xl overflow-hidden relative bg-slate-50">
                                <img id="sentence-image" class="w-full h-full object-cover opacity-0 transition-opacity duration-500" alt="Illustration">
                                <div id="image-loading" class="absolute inset-0 flex items-center justify-center text-slate-400 bg-slate-100 shimmer">
                                    <i class="fas fa-image mr-2"></i> Generating Image...
                                </div>
                            </div>

                            <!-- Font sizes increased here -->
                            <p id="english-text" class="text-4xl sm:text-5xl md:text-6xl font-bold text-slate-800 mb-6 leading-tight"></p>
                            <div id="japanese-wrapper" class="h-auto min-h-[5rem] overflow-hidden transition-all duration-300 opacity-0 transform translate-y-4">
                                <p id="japanese-text" class="text-2xl sm:text-3xl text-brand-600 font-medium"></p>
                            </div>
                            <p class="text-xs text-slate-400 mt-8 uppercase tracking-widest">Click to reveal</p>
                        </div>
                    </div>
                </div>
                
                <!-- Pronunciation Feedback Area -->
                 <div id="pronunciation-feedback-container" class="mt-6"></div>
            </div>

            <!-- Controls -->
            <div class="mt-auto">
                <div class="flex justify-center items-center space-x-4 mb-8">
                    <button id="speak-btn" class="btn btn-secondary rounded-full w-12 h-12 p-0 flex items-center justify-center hover:bg-brand-50 hover:text-brand-600 border-slate-200 shadow-sm" title="音声を聞く">
                        <i class="fas fa-volume-up text-lg"></i>
                    </button>
                    
                    <button id="record-btn" class="btn btn-red rounded-full w-16 h-16 p-0 flex items-center justify-center shadow-lg shadow-red-200 hover:shadow-red-300 transform transition hover:-translate-y-1" title="発音練習">
                        <i id="mic-icon" class="fas fa-microphone text-2xl"></i>
                    </button>
                    
                    <button id="play-recording-btn" class="btn btn-green btn-disabled rounded-full w-12 h-12 p-0 flex items-center justify-center shadow-sm" disabled title="自分の声を聞く">
                        <i class="fas fa-play text-lg"></i>
                    </button>
                </div>
                <audio id="recording-player" class="hidden"></audio>

                <div class="flex justify-between items-center">
                    <button id="prev-btn" class="btn btn-secondary px-6"><i class="fas fa-chevron-left mr-2"></i> 前へ</button>
                    <button id="start-test-btn" class="btn btn-primary px-8 shadow-glow">テストへ進む <i class="fas fa-graduation-cap ml-2"></i></button>
                    <button id="next-btn" class="btn btn-secondary px-6">次へ <i class="fas fa-chevron-right ml-2"></i></button>
                </div>
            </div>
        </section>

        <!-- Test Options Section -->
        <section id="test-options-section" class="card hidden text-center py-16">
            <div class="mb-8">
                <div class="w-20 h-20 bg-brand-100 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i class="fas fa-clipboard-check text-3xl text-brand-600"></i>
                </div>
                <h2 class="text-3xl font-bold text-slate-800 mb-4">ランダムテスト</h2>
                <p class="text-slate-500 max-w-md mx-auto">学習した単語の中からランダムで出題します。<br>自信がついたら挑戦してみましょう。</p>
            </div>
            
            <div id="test-choices" class="flex flex-wrap justify-center gap-4 mb-12">
                <!-- Generated buttons -->
            </div>
             <button id="back-to-learning-btn" class="text-slate-500 hover:text-slate-800 font-medium transition">学習に戻る</button>
        </section>

        <!-- Quiz Section -->
        <section id="quiz-section" class="card hidden">
            <div class="flex justify-between items-center mb-8 pb-4 border-b border-slate-100">
                 <div class="flex items-center">
                    <h2 class="text-xl font-bold text-slate-800 mr-4">テスト中</h2>
                    <span id="quiz-progress" class="bg-brand-100 text-brand-700 text-xs font-bold px-2 py-1 rounded-md font-mono"></span>
                 </div>
                 <button id="abort-test-btn" class="text-sm text-slate-400 hover:text-red-500 transition">中断する</button>
            </div>
            
            <div class="mb-8 min-h-[200px] flex flex-col justify-center">
                <p class="text-sm text-slate-400 text-center mb-2 uppercase tracking-wider">Question</p>
                <!-- Increased Font Size -->
                <p id="quiz-question" class="text-center text-4xl sm:text-5xl font-bold text-slate-800 mb-8 leading-tight"></p>
                
                <div id="quiz-options" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                </div>
            </div>
            
             <div id="feedback" class="text-center font-bold my-6 min-h-[40px] rounded-lg flex items-center justify-center text-lg"></div>
            
            <div class="text-center h-14">
                 <button id="next-question-btn" class="hidden btn btn-primary w-full sm:w-auto px-8">
                    次の問題へ <i class="fas fa-arrow-right ml-2"></i>
                 </button>
            </div>
        </section>

        <!-- Results Section -->
        <section id="results-section" class="card hidden text-center py-12">
            <div class="mb-8 relative inline-block">
                <svg class="w-40 h-40" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="45" fill="none" stroke="#e2e8f0" stroke-width="8" />
                    <circle id="score-circle" cx="50" cy="50" r="45" fill="none" stroke="#0ea5e9" stroke-width="8" stroke-dasharray="283" stroke-dashoffset="283" transform="rotate(-90 50 50)" class="transition-all duration-1000 ease-out" />
                </svg>
                <div class="absolute inset-0 flex items-center justify-center flex-col">
                    <span class="text-4xl font-bold text-slate-800" id="score-percentage"></span>
                    <span class="text-xs text-slate-400 uppercase">Score</span>
                </div>
            </div>

            <p id="score-text" class="text-xl text-slate-600 mb-8"></p>

            <div id="incorrect-answers-container" class="text-left bg-red-50 border border-red-100 rounded-xl p-6 mb-8 hidden">
                <h3 class="text-lg font-bold text-red-800 mb-4 flex items-center">
                    <i class="fas fa-exclamation-circle mr-2"></i> 復習が必要な単語
                </h3>
                <ul id="incorrect-answers-list" class="space-y-3">
                </ul>
            </div>

            <div class="flex flex-col sm:flex-row justify-center gap-4">
                <button id="restart-btn" class="btn btn-primary w-full sm:w-auto">
                    <i class="fas fa-redo mr-2"></i> もう一度挑戦
                </button>
                <button id="back-to-home-btn" class="btn btn-secondary w-full sm:w-auto">
                    ホームに戻る
                </button>
            </div>
        </section>

    </div>

    <!-- PDF Download Modal -->
    <div id="pdf-modal" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm overflow-y-auto h-full w-full flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="relative mx-auto p-0 border-0 w-11/12 md:w-2/3 lg:w-1/2 shadow-2xl rounded-2xl bg-white overflow-hidden transform scale-100 transition-transform duration-300">
            <div class="bg-slate-50 px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                <h3 class="text-lg font-bold text-slate-800">PDFダウンロード</h3>
                <button id="close-modal-icon" class="text-slate-400 hover:text-slate-600 transition">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6">
                <p class="text-sm text-slate-500 mb-4">用途に合わせてプリント形式を選択してください。</p>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <button id="download-list-btn" class="p-4 border border-slate-200 rounded-xl hover:border-brand-500 hover:bg-brand-50 text-left transition group">
                        <div class="font-bold text-slate-700 group-hover:text-brand-700 mb-1">1. 単語リスト</div>
                        <div class="text-xs text-slate-400">完全な単語一覧表</div>
                    </button>
                    <button id="download-en-quiz-btn" class="p-4 border border-slate-200 rounded-xl hover:border-brand-500 hover:bg-brand-50 text-left transition group">
                        <div class="font-bold text-slate-700 group-hover:text-brand-700 mb-1">2. 英単語テスト</div>
                        <div class="text-xs text-slate-400">日本語を見て英語を書く</div>
                    </button>
                    <button id="download-ja-quiz-btn" class="p-4 border border-slate-200 rounded-xl hover:border-brand-500 hover:bg-brand-50 text-left transition group">
                        <div class="font-bold text-slate-700 group-hover:text-brand-700 mb-1">3. 和訳テスト</div>
                        <div class="text-xs text-slate-400">英語を見て日本語を書く</div>
                    </button>
                    <button id="download-mixed-quiz-btn" class="p-4 border border-slate-200 rounded-xl hover:border-brand-500 hover:bg-brand-50 text-left transition group">
                        <div class="font-bold text-slate-700 group-hover:text-brand-700 mb-1">4. 混合テスト</div>
                        <div class="text-xs text-slate-400">英訳と和訳のランダム</div>
                    </button>
                    <button id="download-sentence-quiz-btn" class="p-4 border border-slate-200 rounded-xl hover:border-brand-500 hover:bg-brand-50 text-left transition group">
                        <div class="font-bold text-slate-700 group-hover:text-brand-700 mb-1">5. 例文穴埋め</div>
                        <div class="text-xs text-slate-400">文脈から単語を推測</div>
                    </button>
                    <button id="download-sentence-mixed-quiz-btn" class="p-4 border border-slate-200 rounded-xl hover:border-brand-500 hover:bg-brand-50 text-left transition group">
                        <div class="font-bold text-slate-700 group-hover:text-brand-700 mb-1">6. 例文実戦テスト</div>
                        <div class="text-xs text-slate-400">穴埋めと下線部和訳</div>
                    </button>
                </div>
            </div>
            <div class="bg-slate-50 px-6 py-4 border-t border-slate-100 text-right">
                <button id="close-modal-btn" class="text-sm font-medium text-slate-500 hover:text-slate-800 transition">閉じる</button>
            </div>
        </div>
    </div>


    <script>
        const vocabularyData = [
            {"english": "play", "japanese": "(映画などが)上映される", "sentence": "What movie is playing at the theater?", "sentence_ja": "劇場では何の映画が上映されていますか？"},
            {"english": "Could you~?", "japanese": "~していただけますか?", "sentence": "Could you open the window?", "sentence_ja": "窓を開けていただけますか？"},
            {"english": "laundry", "japanese": "洗濯物", "sentence": "I have to do the laundry today.", "sentence_ja": "私は今日、洗濯をしなければならない。"},
            {"english": "go ahead", "japanese": "(承認・賛成を表して)どうぞ、構いませんよ", "sentence": "Go ahead and eat.", "sentence_ja": "どうぞ食べてください。"},
            {"english": "belong to ~", "japanese": "~に所属する", "sentence": "I belong to the tennis club.", "sentence_ja": "私はテニスクラブに所属しています。"},
            {"english": "be supposed to", "japanese": "~することになっている", "sentence": "You are supposed to be here at 9.", "sentence_ja": "あなたは9時にここにいることになっています。"},
            {"english": "would rather", "japanese": "むしろ〜したい", "sentence": "I would rather stay home than go out.", "sentence_ja": "外出するよりむしろ家にいたい。"},
            {"english": "available", "japanese": "(手が空いて) 会うことができる", "sentence": "Are you available tomorrow?", "sentence_ja": "明日は空いていますか？"},
            {"english": "unusual", "japanese": "珍しい", "sentence": "It is unusual for him to be late.", "sentence_ja": "彼が遅刻するのは珍しい。"},
            {"english": "Don't you ~?", "japanese": "~しないのですか?", "sentence": "Don't you want to go?", "sentence_ja": "行きたくないのですか？"},
            {"english": "take off", "japanese": "(ある期間・日)に休みを取る", "sentence": "I will take a day off next week.", "sentence_ja": "来週1日休みを取ります。"},
            {"english": "so that", "japanese": "~するために", "sentence": "I study hard so that I can pass the exam.", "sentence_ja": "試験に合格するために一生懸命勉強する。"},
            {"english": "appointment", "japanese": "予約、約束", "sentence": "I have a dentist appointment.", "sentence_ja": "歯医者の予約があります。"},
            {"english": "apparently", "japanese": "どうやら〜らしい", "sentence": "Apparently, it's going to rain.", "sentence_ja": "どうやら雨が降るらしい。"},
            {"english": "according to", "japanese": "~によると", "sentence": "According to the news, it will be cold.", "sentence_ja": "ニュースによると寒くなるそうだ。"},
            {"english": "take a look", "japanese": "見る", "sentence": "Take a look at this picture.", "sentence_ja": "この写真を見てください。"},
            {"english": "skip", "japanese": "~を抜く [省く]", "sentence": "Don't skip breakfast.", "sentence_ja": "朝食を抜かないでください。"},
            {"english": "surprise party", "japanese": "サプライズパーティー", "sentence": "We threw a surprise party for her.", "sentence_ja": "私たちは彼女のためにサプライズパーティーを開いた。"},
            {"english": "Shall I~?", "japanese": "~しましょうか?", "sentence": "Shall I help you?", "sentence_ja": "手伝いましょうか？"},
            {"english": "decoration", "japanese": "装飾物、飾りつけ", "sentence": "The Christmas decorations are beautiful.", "sentence_ja": "クリスマスの飾りつけは美しい。"},
            {"english": "take care of", "japanese": "~することを責任をもって引き受ける", "sentence": "I will take care of the dog.", "sentence_ja": "私が犬の世話を引き受けます。"},
            {"english": "join", "japanese": "~に加わる", "sentence": "Will you join us for dinner?", "sentence_ja": "夕食に加わりませんか？"},
            {"english": "tire", "japanese": "タイヤ", "sentence": "The car has a flat tire.", "sentence_ja": "車のタイヤがパンクしている。"},
            {"english": "go flat", "japanese": "(タイヤが) パンクする", "sentence": "My bike tire went flat.", "sentence_ja": "自転車のタイヤがパンクした。"},
            {"english": "manage", "japanese": "なんとかする", "sentence": "I can manage it by myself.", "sentence_ja": "自分でなんとかできます。"},
            {"english": "by oneself", "japanese": "自分で、自力で", "sentence": "He fixed the car by himself.", "sentence_ja": "彼は自力で車を直した。"},
            {"english": "front desk", "japanese": "受付、フロント", "sentence": "Please leave your key at the front desk.", "sentence_ja": "鍵をフロントに預けてください。"},
            {"english": "check out", "japanese": "チェックアウトする", "sentence": "We need to check out by 10 am.", "sentence_ja": "午前10時までにチェックアウトしなければならない。"},
            {"english": "pack", "japanese": "荷造りをする", "sentence": "I have to pack for my trip.", "sentence_ja": "旅行の荷造りをしなければならない。"},
            {"english": "taste", "japanese": "~な味がする", "sentence": "This soup tastes good.", "sentence_ja": "このスープはおいしい味がする。"},
            {"english": "desalinate", "japanese": "~を脱塩する", "sentence": "They desalinate sea water to drink.", "sentence_ja": "彼らは海水を脱塩して飲む。"},
            {"english": "get done", "japanese": "~してもらう", "sentence": "I got my hair cut.", "sentence_ja": "私は髪を切ってもらった。"},
            {"english": "repair", "japanese": "~を修理する", "sentence": "Can you repair this watch?", "sentence_ja": "この時計を修理できますか？"},
            {"english": "sidewalk", "japanese": "歩道", "sentence": "Walk on the sidewalk.", "sentence_ja": "歩道を歩きなさい。"},
            {"english": "at least", "japanese": "少なくとも", "sentence": "It will cost at least $100.", "sentence_ja": "少なくとも100ドルはかかるだろう。"},
            {"english": "reservation", "japanese": "予約", "sentence": "I made a reservation for dinner.", "sentence_ja": "夕食の予約をした。"},
            {"english": "check in", "japanese": "チェックインする", "sentence": "We checked in at the hotel.", "sentence_ja": "私たちはホテルにチェックインした。"},
            {"english": "ask to", "japanese": "~するように頼む", "sentence": "I asked him to help me.", "sentence_ja": "私は彼に手伝うように頼んだ。"},
            {"english": "by noon", "japanese": "正午までに", "sentence": "Finish this work by noon.", "sentence_ja": "正午までにこの仕事を終わらせなさい。"},
            {"english": "quarter", "japanese": "4分の1", "sentence": "A quarter of the students are absent.", "sentence_ja": "生徒の4分の1が欠席している。"},
            {"english": "pass", "japanese": "(時が)過ぎる; (時)を過ごす", "sentence": "Time passes quickly.", "sentence_ja": "時は早く過ぎる。"},
            {"english": "twice as much as", "japanese": "~の2倍の量の", "sentence": "He eats twice as much as I do.", "sentence_ja": "彼は私の2倍の量を食べる。"},
            {"english": "gas", "japanese": "ガソリン; ガス", "sentence": "We are running out of gas.", "sentence_ja": "ガソリンがなくなりかけている。"},
            {"english": "for", "japanese": "(期間)の間(ずっと)", "sentence": "I studied for three hours.", "sentence_ja": "私は3時間ずっと勉強した。"},
            {"english": "forget to", "japanese": "~することを忘れる", "sentence": "Don't forget to lock the door.", "sentence_ja": "ドアに鍵をかけるのを忘れないで。"},
            {"english": "avoid -ing", "japanese": "~するのを避ける", "sentence": "He avoided answering the question.", "sentence_ja": "彼は質問に答えるのを避けた。"},
            {"english": "overcook", "japanese": "~を加熱しすぎる", "sentence": "Be careful not to overcook the pasta.", "sentence_ja": "パスタを茹で過ぎないように気をつけて。"},
            {"english": "so much", "japanese": "とても多くの", "sentence": "Thank you so much.", "sentence_ja": "本当にありがとう。"},
            {"english": "heavy", "japanese": "(交通量などが)多い", "sentence": "Traffic is heavy today.", "sentence_ja": "今日は交通量が多い。"},
            {"english": "bumper to bumper", "japanese": "数珠つなぎに", "sentence": "The cars were bumper to bumper.", "sentence_ja": "車は数珠つなぎだった。"},
            {"english": "help to", "japanese": "~するのに役立つ", "sentence": "Music helps to relax.", "sentence_ja": "音楽はリラックスするのに役立つ。"},
            {"english": "make", "japanese": "~にする", "sentence": "His jokes made me happy.", "sentence_ja": "彼の冗談は私を幸せにした。"},
            {"english": "don't think that", "japanese": "~しないと思う", "sentence": "I don't think that he is coming.", "sentence_ja": "彼が来るとは思わない。"},
            {"english": "niece", "japanese": "めい", "sentence": "My niece is five years old.", "sentence_ja": "私の姪は5歳です。"},
            {"english": "put the finishing touches on", "japanese": "~に最後の仕上げをする", "sentence": "I put the finishing touches on my painting.", "sentence_ja": "私は絵に最後の仕上げをした。"},
            {"english": "apply to", "japanese": "~に出願する", "sentence": "I applied to the university.", "sentence_ja": "私はその大学に出願した。"},
            {"english": "be concerned about", "japanese": "~を心配している", "sentence": "I am concerned about his health.", "sentence_ja": "私は彼の健康を心配している。"},
            {"english": "make it", "japanese": "成功する; 間に合う", "sentence": "I hope you make it as a musician.", "sentence_ja": "あなたが音楽家として成功することを願っています。"},
            {"english": "so that", "japanese": "非常に〜なので", "sentence": "It was so cold that I stayed home.", "sentence_ja": "非常に寒かったので家にいた。"},
            {"english": "deaf", "japanese": "耳が聞こえない", "sentence": "He is completely deaf.", "sentence_ja": "彼は完全に耳が聞こえない。"},
            {"english": "by the time", "japanese": "~する時までに(は)", "sentence": "By the time he arrived, the party was over.", "sentence_ja": "彼が到着する時までには、パーティーは終わっていた。"},
            {"english": "push", "japanese": "~に押しつける", "sentence": "Don't push your ideas on others.", "sentence_ja": "自分の考えを他人に押しつけないで。"},
            {"english": "have no choice but to", "japanese": "~するより仕方がない", "sentence": "I have no choice but to accept it.", "sentence_ja": "それを受け入れるより仕方がない。"},
            {"english": "associate with", "japanese": "AをBと関連づける", "sentence": "I associate red with apples.", "sentence_ja": "私は赤をリンゴと関連づける。"},
            {"english": "distinction", "japanese": "区別", "sentence": "There is a clear distinction between them.", "sentence_ja": "それらの間には明確な区別がある。"},
            {"english": "go on to", "japanese": "続けて~する", "sentence": "He went on to become a doctor.", "sentence_ja": "彼は続けて医者になった。"},
            {"english": "unlock", "japanese": "~を解放する", "sentence": "Education unlocks your potential.", "sentence_ja": "教育はあなたの可能性を解放する。"},
            {"english": "hidden", "japanese": "隠れた", "sentence": "He has a hidden talent.", "sentence_ja": "彼には隠れた才能がある。"},
            {"english": "potential", "japanese": "可能性", "sentence": "You have great potential.", "sentence_ja": "あなたには素晴らしい可能性がある。"},
            {"english": "coincidence", "japanese": "偶然", "sentence": "What a coincidence!", "sentence_ja": "なんて偶然だ！"},
            {"english": "pollution", "japanese": "公害;汚染", "sentence": "Air pollution is a serious problem.", "sentence_ja": "大気汚染は深刻な問題だ。"},
            {"english": "noise", "japanese": "騒音", "sentence": "The noise kept me awake.", "sentence_ja": "騒音で眠れなかった。"},
            {"english": "as as", "japanese": "･･･と同じくらい〜", "sentence": "He is as tall as his father.", "sentence_ja": "彼は父親と同じくらい背が高い。"},
            {"english": "unable to", "japanese": "~することができない", "sentence": "I was unable to attend the meeting.", "sentence_ja": "私は会議に出席することができなかった。"},
            {"english": "put up with", "japanese": "~を我慢する", "sentence": "I cannot put up with this noise.", "sentence_ja": "私はこの騒音を我慢できない。"},
            {"english": "suffer from", "japanese": "(病気など) に苦しむ", "sentence": "He suffers from headaches.", "sentence_ja": "彼は頭痛に苦しんでいる。"},
            {"english": "physical", "japanese": "身体の", "sentence": "Physical exercise is good for you.", "sentence_ja": "身体の運動はあなたに良い。"},
            {"english": "experiment", "japanese": "実験", "sentence": "We conducted an experiment in class.", "sentence_ja": "私たちは授業で実験を行った。"},
            {"english": "last", "japanese": "続く", "sentence": "The meeting lasted two hours.", "sentence_ja": "会議は2時間続いた。"},
            {"english": "have trouble -ing", "japanese": "~するのに苦労する", "sentence": "I have trouble sleeping.", "sentence_ja": "眠るのに苦労している。"},
            {"english": "in order to", "japanese": "~するために", "sentence": "I study in order to learn.", "sentence_ja": "学ぶために勉強する。"},
            {"english": "make it for to", "japanese": "~が･･･するのを~にする", "sentence": "Technology makes it easy for us to communicate.", "sentence_ja": "技術は私たちが通信するのを簡単にする。"},
            {"english": "in addition", "japanese": "そのうえ", "sentence": "In addition, it is cheap.", "sentence_ja": "そのうえ、それは安い。"},
            {"english": "come to the conclusion that", "japanese": "~という結論に達する", "sentence": "I came to the conclusion that he was right.", "sentence_ja": "彼が正しいという結論に達した。"},
            {"english": "times less than", "japanese": "･･･のX倍少ない", "sentence": "This uses three times less energy than that.", "sentence_ja": "これはあれの3分の1のエネルギーしか使わない。"},
            {"english": "help", "japanese": "手伝う", "sentence": "Please help me.", "sentence_ja": "私を手伝ってください。"},
            {"english": "used to", "japanese": "よく〜したものだった", "sentence": "I used to play soccer.", "sentence_ja": "私はよくサッカーをしたものだった。"},
            {"english": "scene", "japanese": "景色、眺め", "sentence": "The mountain scene was beautiful.", "sentence_ja": "山の景色は美しかった。"},
            {"english": "every", "japanese": "どの〜も", "sentence": "Every student must study.", "sentence_ja": "どの生徒も勉強しなければならない。"},
            {"english": "think about", "japanese": "~を考える", "sentence": "I will think about it.", "sentence_ja": "それについて考えます。"},
            {"english": "consider", "japanese": "~を考える", "sentence": "Please consider my offer.", "sentence_ja": "私の申し出を考えてください。"},
            {"english": "what we should do", "japanese": "何をすべきか", "sentence": "I don't know what we should do.", "sentence_ja": "何をすべきかわからない。"},
            {"english": "what to do", "japanese": "何をすべきか", "sentence": "Tell me what to do.", "sentence_ja": "何をすべきか教えて。"},
            {"english": "protect", "japanese": "~を保護する", "sentence": "We must protect nature.", "sentence_ja": "自然を保護しなければならない。"},
            {"english": "serious", "japanese": "深刻な", "sentence": "This is a serious problem.", "sentence_ja": "これは深刻な問題だ。"},
            {"english": "it is necessary to", "japanese": "~することが必要だ", "sentence": "It is necessary to sleep well.", "sentence_ja": "よく眠ることが必要だ。"},
            {"english": "the number of", "japanese": "~の数", "sentence": "The number of cars is increasing.", "sentence_ja": "車の数が増えている。"},
            {"english": "more and more", "japanese": "ますます多くの", "sentence": "More and more people use smartphones.", "sentence_ja": "ますます多くの人がスマホを使っている。"},
            {"english": "few of", "japanese": "ほとんど(の) ~ない", "sentence": "Few of my friends live here.", "sentence_ja": "私の友人のほとんどはここに住んでいない。"},
            {"english": "opportunity", "japanese": "機会", "sentence": "Thank you for the opportunity.", "sentence_ja": "機会をありがとう。"},
            {"english": "experience-based", "japanese": "体験型の", "sentence": "This is an experience-based learning program.", "sentence_ja": "これは体験型の学習プログラムだ。"},
            {"english": "enable to", "japanese": "~することを可能にする", "sentence": "This tool enables us to work faster.", "sentence_ja": "この道具は私たちがより早く働くことを可能にする。"},
            {"english": "para-athlete", "japanese": "パラアスリート", "sentence": "The para-athlete won a gold medal.", "sentence_ja": "そのパラアスリートは金メダルを獲得した。"}
        ];

        // --- STATE ---
        let vocabulary = [];
        let selectedWords = [];
        let currentWordIndex = 0;
        let learningMode = 'word';
        let quizQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let incorrectAnswers = [];

        // --- AUDIO STATE ---
        let mediaRecorder;
        let audioChunks = [];
        let recordedAudioURL = null;
        let micStream = null;
        let synth = window.speechSynthesis;
        let voices = [];
        let recognition;

        // --- DOM ELEMENTS ---
        const sections = {
            setup: document.getElementById('setup-section'),
            learning: document.getElementById('learning-section'),
            testOptions: document.getElementById('test-options-section'),
            quiz: document.getElementById('quiz-section'),
            results: document.getElementById('results-section'),
        };
        const wordListContainer = document.getElementById('word-list');
        const startLearningBtn = document.getElementById('start-learning-btn');
        const quickTestBtn = document.getElementById('quick-test-btn'); // Added missing element
        const downloadPdfBtn = document.getElementById('download-pdf-btn');
        const pdfModal = document.getElementById('pdf-modal');
        const flashcardContainer = document.getElementById('flashcard-container');
        const illustrationArea = document.getElementById('illustration-area');
        const sentenceImage = document.getElementById('sentence-image');
        const imageLoading = document.getElementById('image-loading');
        const englishText = document.getElementById('english-text');
        const japaneseWrapper = document.getElementById('japanese-wrapper');
        const japaneseText = document.getElementById('japanese-text');
        const progressIndicator = document.getElementById('progress-indicator');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const startTestBtn = document.getElementById('start-test-btn');
        const speakBtn = document.getElementById('speak-btn');
        const recordBtn = document.getElementById('record-btn');
        const playRecordingBtn = document.getElementById('play-recording-btn');
        const recordingPlayer = document.getElementById('recording-player');
        const pronunciationFeedbackContainer = document.getElementById('pronunciation-feedback-container');

        // --- FUNCTIONS ---
        function switchSection(sectionToShow) {
            Object.values(sections).forEach(section => {
                section.classList.add('hidden');
                section.classList.remove('animate-fade-in');
            });
            if (sections[sectionToShow]) {
                sections[sectionToShow].classList.remove('hidden');
                // Small delay to ensure DOM is ready for animation
                requestAnimationFrame(() => {
                    sections[sectionToShow].classList.add('animate-fade-in');
                });
            }
        }

        function populateWordList() {
            wordListContainer.innerHTML = '';
            vocabulary.forEach((word, index) => {
                const label = document.createElement('label');
                // Increased padding and text size for better readability
                label.className = 'flex items-center space-x-3 p-4 rounded-lg hover:bg-white hover:shadow-sm cursor-pointer text-lg transition-all border border-transparent hover:border-slate-100';
                label.innerHTML = `
                    <input type="checkbox" class="form-checkbox h-5 w-5 text-brand-600 rounded border-slate-300 focus:ring-brand-500 word-checkbox" data-index="${index}">
                    <span class="text-slate-700 font-medium">${word.english}</span>
                `;
                wordListContainer.appendChild(label);
            });
        }
        
        function highlightPhraseInSentence(sentence, phrase) {
             const cleanPhrase = phrase
                .replace(/\(.*\)|~|\?|\+|A to B|A as B|A as well as B|O from -ing|O to do/g, '') // O関連 削除
                .replace(/ S' \+ V'| S \+ seem\(s\) \+ to do/g, '')
                .replace(/\.\.\. that/g, '')
                .replace(/\[.*?\]/g, '') // Fixed regex
                .replace(/\bone's\b/g, '\\w+\'s')
                .trim();
            
            const words = cleanPhrase.split(/[\s\/]+/);
            const firstWord = words[0];
            const restOfWords = words.slice(1);

            // 一般的な動詞の活用形を処理
            const irregulars = {
                get: '(get|gets|getting|got|gotten)',
                be: '(is|am|are|was|were|be|being|been)',
                do: '(do|does|doing|did|done)',
                have: '(has|have|having|had)',
                eat: '(eat|eats|eating|ate|eaten)',
                go: '(go|goes|going|went|gone)',
                make: '(make|makes|making|made)',
                take: '(take|takes|taking|took|taken)',
                play: '(play|plays|playing|played)',
                belong: '(belong|belongs|belonging|belonged)',
                skip: '(skip|skips|skipping|skipped)',
                join: '(join|joins|joining|joined)',
                manage: '(manage|manages|managing|managed)',
                check: '(check|checks|checking|checked)',
                pack: '(pack|packs|packing|packed)',
                taste: '(taste|tastes|tasting|tasted)',
                repair: '(repair|repairs|repairing|repaired)',
                ask: '(ask|asks|asking|asked)',
                pass: '(pass|passes|passing|passed)',
                forget: '(forget|forgets|forgetting|forgot|forgotten)',
                avoid: '(avoid|avoids|avoiding|avoided)',
                help: '(help|helps|helping|helped)',
                think: '(think|thinks|thinking|thought)',
                apply: '(apply|applies|applying|applied)',
                push: '(push|pushes|pushing|pushed)',
                associate: '(associate|associates|associating|associated)',
                unlock: '(unlock|unlocks|unlocking|unlocked)',
                suffer: '(suffer|suffers|suffering|suffered)',
                last: '(last|lasts|lasting|lasted)',
                come: '(come|comes|coming|came)',
                use: '(use|uses|using|used)',
                consider: '(consider|considers|considering|considered)',
                protect: '(protect|protects|protecting|protected)',
                enable: '(enable|enables|enabling|enabled)',
            };

            let firstWordRegex;
            if (irregulars[firstWord.toLowerCase()]) {
                firstWordRegex = `\\b${irregulars[firstWord.toLowerCase()]}\\b`;
            } else if (/\w+/.test(firstWord)) {
                 // 記号でない場合、活用形を推測
                firstWordRegex = `\\b${firstWord}(s|es|ed|ing)?\\b`;
            } else {
                // 記号などの場合、そのままエスケープ
                firstWordRegex = `\\b${firstWord.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')}\\b`;
            }

            let finalRegex;
            if (restOfWords.length > 0) {
                const restRegex = restOfWords.map(w => w.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')).join('\\s+');
                finalRegex = new RegExp(`(${firstWordRegex}\\s+${restRegex})`, 'gi');
            } else {
                finalRegex = new RegExp(`(${firstWordRegex})`, 'gi');
            }
            
            if (finalRegex.test(sentence)) {
                return sentence.replace(finalRegex, `<span class="text-brand-600 border-b-2 border-brand-400">$1</span>`);
            }
            
            const fallbackRegex = new RegExp(`(${cleanPhrase.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi');
            if(fallbackRegex.test(sentence)){
                 return sentence.replace(fallbackRegex, `<span class="text-brand-600 border-b-2 border-brand-400">$1</span>`);
            }

            return sentence;
        }

        function updateLearningView() {
            const word = selectedWords[currentWordIndex];
            learningMode = document.querySelector('input[name="mode"]:checked').value;

            if (learningMode === 'sentence') {
                // Show illustration area
                illustrationArea.classList.remove('hidden');
                
                // Reset image state
                sentenceImage.classList.add('opacity-0');
                imageLoading.classList.remove('hidden');
                
                // Generate Image
                const sentenceForPrompt = word.sentence ? word.sentence : word.english;
                // Use Pollinations.ai for dynamic image generation
                // Added seed to ensure same image for same sentence but different enough
                const seed = Math.floor(Math.random() * 1000); 
                const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(sentenceForPrompt + ", flat illustration style, minimal, clean background")}?width=600&height=400&nologo=true&seed=${seed}`;
                
                sentenceImage.src = imageUrl;
                sentenceImage.onload = () => {
                    imageLoading.classList.add('hidden');
                    sentenceImage.classList.remove('opacity-0');
                };
            } else {
                // Hide illustration in word mode
                illustrationArea.classList.add('hidden');
                sentenceImage.src = ''; // Clear source
            }


            if (learningMode === 'sentence' && word.sentence && word.sentence_ja) {
                let sentenceJa = word.sentence_ja;
                const japanesePhrase = word.japanese.split(/[(（\/]/)[0].trim(); // 括弧やスラッシュ以降を削除
                if (sentenceJa.includes(japanesePhrase)) {
                    japaneseText.innerHTML = sentenceJa.replace(new RegExp(japanesePhrase, 'g'), `<span class="text-brand-600 font-bold border-b border-brand-300">${japanesePhrase}</span>`);
                } else {
                    japaneseText.textContent = sentenceJa;
                }
                englishText.innerHTML = highlightPhraseInSentence(word.sentence, word.english);
            } else {
                englishText.innerHTML = word.english;
                japaneseText.textContent = word.japanese;
            }
            
            // Reset flashcard state
            japaneseWrapper.classList.remove('opacity-100', 'translate-y-0');
            japaneseWrapper.classList.add('opacity-0', 'translate-y-4');
            
            pronunciationFeedbackContainer.innerHTML = '';
            pronunciationFeedbackContainer.className = 'mt-6';
            progressIndicator.textContent = `${currentWordIndex + 1} / ${selectedWords.length}`;

            prevBtn.disabled = currentWordIndex === 0;
            nextBtn.disabled = currentWordIndex === selectedWords.length - 1;
            prevBtn.classList.toggle('btn-disabled', prevBtn.disabled);
            nextBtn.classList.toggle('btn-disabled', nextBtn.disabled);

            playRecordingBtn.disabled = true;
            playRecordingBtn.classList.add('btn-disabled');
            recordedAudioURL = null;
        }

        function loadVoices() {
            voices = synth.getVoices();
             if (voices.length === 0) {
                setTimeout(loadVoices, 100);
            }
        }

        function speak(text) {
             if (synth.speaking) {
                return; // Prevent overlapping speech
            }
            const cleanText = text.replace(/<[^>]*>/g, '');
            const utterance = new SpeechSynthesisUtterance(cleanText);
            
            let selectedVoice = voices.find(voice => voice.name === 'Google US English') || voices.find(voice => voice.lang === 'en-US' && voice.name.includes('Google')) || voices.find(voice => voice.lang === 'en-US');
            
            if (selectedVoice) {
                utterance.voice = selectedVoice;
            }
            
            utterance.rate = 0.9; // Slightly slower for learning
            utterance.lang = 'en-US';
            synth.speak(utterance);
        }

        function showTestOptions() {
            const numSelected = selectedWords.length;
            const testChoicesContainer = document.getElementById('test-choices');
            testChoicesContainer.innerHTML = '';

            const options = [];
            if (numSelected >= 10) options.push(10);
            if (numSelected >= 20) options.push(20);
            
            if (options.length === 0 && numSelected > 0) {
                 options.push(numSelected);
            } else if (numSelected > 0 && !options.includes(numSelected)) {
                 options.push(numSelected);
            }

            if (options.length > 0) {
                options.sort((a,b)=> a-b).forEach(num => {
                    const button = document.createElement('button');
                    button.className = 'btn btn-primary w-32 h-32 flex flex-col items-center justify-center text-xl shadow-lg hover:scale-105 transform transition-all';
                    button.innerHTML = `<span class="text-4xl mb-2 font-bold">${num}</span><span class="text-sm opacity-80">Questions</span>`;
                    button.onclick = () => generateTest(num);
                    testChoicesContainer.appendChild(button);
                });
            } else {
                testChoicesContainer.innerHTML = `<p class="text-red-500 bg-red-50 px-6 py-4 rounded-xl">テストを行うには、少なくとも1つの単語を選択してください。</p>`;
            }
            switchSection('testOptions');
        }

        function generateTest(numQuestions) {
            quizQuestions = [];
            score = 0;
            currentQuestionIndex = 0;
            incorrectAnswers = [];
            
            const shuffled = [...selectedWords].sort(() => 0.5 - Math.random());
            const questions = shuffled.slice(0, numQuestions);

            quizQuestions = questions.map(q => {
                const correctAnswer = q.japanese;
                let options = [correctAnswer];

                while (options.length < 4) {
                    const randomWord = vocabulary[Math.floor(Math.random() * vocabulary.length)];
                    if (!options.includes(randomWord.japanese)) {
                        options.push(randomWord.japanese);
                    }
                }
                return {
                    question: q.english,
                    correct: correctAnswer,
                    options: options.sort(() => 0.5 - Math.random())
                };
            });
            
            displayQuizQuestion();
            switchSection('quiz');
        }

        function displayQuizQuestion() {
            const q = quizQuestions[currentQuestionIndex];
            document.getElementById('quiz-question').textContent = q.question;
            const optionsContainer = document.getElementById('quiz-options');
            optionsContainer.innerHTML = '';

            q.options.forEach(option => {
                const optionDiv = document.createElement('div');
                // Added text-xl for bigger option text
                optionDiv.className = 'quiz-option group flex items-center text-xl';
                optionDiv.innerHTML = `<span class="w-6 h-6 rounded-full border-2 border-slate-200 group-hover:border-brand-400 mr-3 flex items-center justify-center"><div class="w-3 h-3 rounded-full bg-brand-500 opacity-0 transition-opacity"></div></span>${option}`;
                optionDiv.onclick = function() {
                    this.querySelector('.w-3').classList.remove('opacity-0');
                    selectAnswer(this, option, q.correct);
                };
                optionsContainer.appendChild(optionDiv);
            });
            
            document.getElementById('quiz-progress').textContent = `${currentQuestionIndex + 1} / ${quizQuestions.length}`;
            document.getElementById('feedback').textContent = '';
            document.getElementById('feedback').className = 'text-center font-bold my-6 min-h-[40px] rounded-lg flex items-center justify-center text-lg';
            document.getElementById('next-question-btn').classList.add('hidden');
        }

        function selectAnswer(element, selectedAnswer, correctAnswer) {
            document.querySelectorAll('.quiz-option').forEach(opt => {
                opt.onclick = null;
                opt.style.cursor = 'default';
                opt.classList.add('opacity-60');
            });
            element.classList.remove('opacity-60');
            
            const feedbackEl = document.getElementById('feedback');
            
            if (selectedAnswer === correctAnswer) {
                element.classList.add('correct');
                element.classList.remove('opacity-60');
                feedbackEl.innerHTML = '<i class="fas fa-check-circle mr-2"></i> 正解！';
                feedbackEl.className = 'text-center font-bold my-6 min-h-[40px] rounded-lg flex items-center justify-center text-lg bg-green-100 text-green-700 border border-green-200';
                score++;
            } else {
                element.classList.add('incorrect');
                element.classList.remove('opacity-60');
                feedbackEl.innerHTML = `<i class="fas fa-times-circle mr-2"></i> 不正解... <span class="ml-2 text-sm font-normal text-slate-600">正解: ${correctAnswer}</span>`;
                feedbackEl.className = 'text-center font-bold my-6 min-h-[40px] rounded-lg flex items-center justify-center text-lg bg-red-100 text-red-700 border border-red-200';
                incorrectAnswers.push({
                    question: quizQuestions[currentQuestionIndex].question,
                    correct: correctAnswer,
                    yourAnswer: selectedAnswer,
                });
                 document.querySelectorAll('.quiz-option').forEach(opt => {
                     if (opt.textContent.includes(correctAnswer)) {
                         opt.classList.add('correct');
                         opt.classList.remove('opacity-60');
                     }
                 });
            }
            document.getElementById('next-question-btn').classList.remove('hidden');
        }
        
        function showResults() {
            const percentage = Math.round((score / quizQuestions.length) * 100);
            document.getElementById('score-percentage').textContent = `${percentage}%`;
            document.getElementById('score-text').textContent = `${score} / ${quizQuestions.length} 正解`;
            
            // Animate score circle
            setTimeout(() => {
                const offset = 283 - (283 * percentage) / 100;
                document.getElementById('score-circle').style.strokeDashoffset = offset;
                
                // Color based on score
                const circle = document.getElementById('score-circle');
                if (percentage >= 80) circle.setAttribute('stroke', '#10b981');
                else if (percentage >= 60) circle.setAttribute('stroke', '#f59e0b');
                else circle.setAttribute('stroke', '#ef4444');
            }, 100);

            const list = document.getElementById('incorrect-answers-list');
            list.innerHTML = '';

            if (incorrectAnswers.length > 0) {
                document.getElementById('incorrect-answers-container').classList.remove('hidden');
                incorrectAnswers.forEach(item => {
                    const li = document.createElement('li');
                    li.className = "bg-white p-3 rounded border border-red-100";
                    li.innerHTML = `<div class="font-bold text-slate-800">${item.question}</div><div class="text-sm text-green-600 mt-1"><i class="fas fa-check mr-1"></i> ${item.correct}</div><div class="text-sm text-red-500"><i class="fas fa-times mr-1"></i> ${item.yourAnswer}</div>`;
                    list.appendChild(li);
                });
            } else {
                 document.getElementById('incorrect-answers-container').classList.add('hidden');
            }
            switchSection('results');
        }

        function getSelectedWordsForPdf() {
            const checkedBoxes = document.querySelectorAll('.word-checkbox:checked');
            if (checkedBoxes.length === 0) {
                alert('ダウンロードする単語を1つ以上選択してください。');
                return null;
            }
            const words = [];
            checkedBoxes.forEach(cb => {
                words.push(vocabulary[cb.dataset.index]);
            });
            return words;
        }

        function openPrintWindow(bodyContent, title) {
            const htmlContent = `
                <!DOCTYPE html>
                <html lang="ja">
                <head>
                    <meta charset="UTF-8">
                    <title>${title}</title>
                    <style>
                        body { font-family: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif; line-height: 1.8; margin: 25px; }
                        @media print { .no-print { display: none; } }
                        h1, h2 { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 25px; }
                        ol, ul { list-style-position: inside; padding-left: 0; }
                        li { margin-bottom: 15px; }
                        .list-container { column-count: 2; column-gap: 40px; }
                        .list-container li { -webkit-column-break-inside: avoid; page-break-inside: avoid; break-inside: avoid; }
                        @media (max-width: 700px) { .list-container { column-count: 1; } }
                        .answer-key { page-break-before: always; }
                        ol { list-style-type: decimal; } 
                    </style>
                </head>
                <body>
                    <h1>${title}</h1>
                    <p class="no-print" style="text-align:center;">
                        印刷ダイアログが表示されない場合は、ブラウザの印刷機能（Ctrl+PまたはCmd+P）を使用してください。
                    </p>
                    ${bodyContent}
                </body>
                </html>
            `;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            setTimeout(() => {
                printWindow.print();
            }, 250);
        }

        // --- STRICT PRONUNCIATION SCORING (Levenshtein Distance) ---
        function levenshteinDistance(s, t) {
            if (!s.length) return t.length;
            if (!t.length) return s.length;
            const arr = [];
            for (let i = 0; i <= t.length; i++) {
                arr[i] = [i];
                for (let j = 1; j <= s.length; j++) {
                    arr[i][j] =
                        i === 0
                            ? j
                            : Math.min(
                                arr[i - 1][j] + 1,
                                arr[i][j - 1] + 1,
                                arr[i - 1][j - 1] + (s[j - 1] === t[i - 1] ? 0 : 1)
                            );
                }
            }
            return arr[t.length][s.length];
        }

        function scorePronunciation(transcript, target) {
            // Normalize text for comparison
            const clean = (text) => text.toLowerCase()
                .replace(/[.,?!'~+]/g, '')
                .replace(/\[.*?\]/g, '')
                .replace(/\(.+?\)/g, '')
                .replace(/\b(s|we|one's|A|B)\b/gi,'') 
                .replace(/~|\/|\+/g, ' ')
                .replace(/\s{2,}/g, ' ')
                .trim();

            const normalizedTranscript = clean(transcript);
            const normalizedTarget = clean(target);
            
            pronunciationFeedbackContainer.innerHTML = '';

            if (normalizedTarget.length === 0) return;

            // Calculate Levenshtein distance for strict character-level comparison
            const distance = levenshteinDistance(normalizedTranscript, normalizedTarget);
            const maxLength = Math.max(normalizedTranscript.length, normalizedTarget.length);
            
            // Calculate similarity percentage (0 to 100)
            const similarity = maxLength === 0 ? 0 : (1 - distance / maxLength);
            const score = Math.max(0, Math.round(similarity * 100));

            let feedbackText = '';
            let feedbackClass = '';
            let icon = '';

            if (score >= 90) {
                feedbackText = `Excellent! 完璧です`;
                feedbackClass = 'feedback-perfect';
                icon = '<i class="fas fa-star mr-2"></i>';
            } else if (score >= 75) {
                feedbackText = `Good Job! 惜しい！`;
                feedbackClass = 'feedback-good';
                 icon = '<i class="fas fa-thumbs-up mr-2"></i>';
            } else if (score >= 50) {
                feedbackText = `Okay. もう少し！`;
                feedbackClass = 'feedback-ok';
                 icon = '<i class="fas fa-check mr-2"></i>';
            } else {
                feedbackText = `Try Again. もう一度`;
                feedbackClass = 'feedback-retry';
                 icon = '<i class="fas fa-redo mr-2"></i>';
            }

            pronunciationFeedbackContainer.innerHTML = `
                <div class="flex flex-col items-center ${feedbackClass} w-full">
                    <div class="text-sm font-normal text-slate-500 mb-1">あなたの発音: "${transcript}"</div>
                    <div class="flex items-center text-xl font-bold">
                        ${icon} Score: <span class="text-3xl ml-2 mr-1">${score}</span>
                    </div>
                    <div class="text-sm font-medium mt-1 opacity-90">${feedbackText}</div>
                </div>`;
        }


        function initializeSpeechRecognition() {
            window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (window.SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.lang = 'en-US';
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;

                recognition.onresult = (event) => {
                    const transcript = event.results[event.results.length - 1][0].transcript.trim();
                    // Get current target text (word or sentence based on mode)
                    let targetText = '';
                    if (learningMode === 'sentence' && selectedWords[currentWordIndex].sentence) {
                        targetText = selectedWords[currentWordIndex].sentence.replace(/<[^>]*>/g, '').trim();
                    } else {
                         targetText = selectedWords[currentWordIndex].english.replace(/<[^>]*>/g, '').trim();
                    }
                    scorePronunciation(transcript, targetText);
                };

                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    let errorMessage = 'エラーが発生しました';
                    if (event.error === 'no-speech') {
                        errorMessage = '音声が検出されませんでした。';
                    } else if (event.error === 'audio-capture') {
                        errorMessage = 'マイクに問題が発生しました。';
                    } else if (event.error === 'not-allowed') {
                        errorMessage = 'マイクへのアクセスが許可されていません。';
                    }
                    pronunciationFeedbackContainer.innerHTML = `<div class="text-red-500 text-sm font-bold bg-red-50 p-2 rounded border border-red-200">${errorMessage}</div>`;
                };
            } else {
                console.warn("Speech Recognition not supported in this browser.");
                recordBtn.disabled = true;
                recordBtn.classList.add('btn-disabled');
                recordBtn.innerHTML = '<i class="fas fa-microphone-slash text-2xl text-slate-400"></i>';
            }
        }

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            vocabulary = vocabularyData;
            populateWordList();
            
            if (typeof speechSynthesis !== 'undefined' && speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = loadVoices;
            }
            loadVoices();
            initializeSpeechRecognition();
            
            // Add animation class
            document.querySelectorAll('.card').forEach(el => el.classList.add('animate-fade-in'));
        });

        flashcardContainer.addEventListener('click', () => {
            japaneseWrapper.classList.toggle('opacity-0');
            japaneseWrapper.classList.toggle('opacity-100');
            japaneseWrapper.classList.toggle('translate-y-4');
            japaneseWrapper.classList.toggle('translate-y-0');
        });

        document.getElementById('select-all').addEventListener('click', () => {
            document.querySelectorAll('.word-checkbox').forEach(cb => cb.checked = true);
        });

        document.getElementById('deselect-all').addEventListener('click', () => {
            document.querySelectorAll('.word-checkbox').forEach(cb => cb.checked = false);
        });

        startLearningBtn.addEventListener('click', () => {
            selectedWords = [];
            const checkedBoxes = document.querySelectorAll('.word-checkbox:checked');
            if (checkedBoxes.length === 0) {
                alert('学習する単語を1つ以上選択してください。');
                return;
            }
            checkedBoxes.forEach(cb => {
                selectedWords.push(vocabulary[cb.dataset.index]);
            });
            currentWordIndex = 0;
            updateLearningView();
            switchSection('learning');
        });

        // Added safe element retrieval and event listener
        if (quickTestBtn) {
            quickTestBtn.addEventListener('click', () => {
                selectedWords = [];
                const checkedBoxes = document.querySelectorAll('.word-checkbox:checked');
                if (checkedBoxes.length === 0) {
                    alert('テストする単語を1つ以上選択してください。');
                    return;
                }
                checkedBoxes.forEach(cb => {
                    // Ensure index is parsed as integer
                    const index = parseInt(cb.dataset.index, 10);
                    if (vocabulary[index]) {
                        selectedWords.push(vocabulary[index]);
                    }
                });
                
                // Directly go to test options
                showTestOptions();
            });
        }

        downloadPdfBtn.addEventListener('click', () => {
             pdfModal.classList.remove('hidden');
             setTimeout(() => pdfModal.querySelector('div').classList.remove('scale-95', 'opacity-0'), 10);
        });
        document.getElementById('close-modal-btn').addEventListener('click', closeModal);
        document.getElementById('close-modal-icon').addEventListener('click', closeModal);
        
        function closeModal() {
            pdfModal.classList.add('hidden');
        }
        
        // --- PDF DOWNLOAD LISTENERS ---
        document.getElementById('download-list-btn').addEventListener('click', () => {
            const words = getSelectedWordsForPdf();
            if (!words) return;
            const listItems = words.map(word => `<li><strong>${word.english}</strong>: ${word.japanese}</li>`).join('');
            openPrintWindow(`<ul class="list-container">${listItems}</ul>`, '重要語句リスト');
            closeModal();
        });

        document.getElementById('download-en-quiz-btn').addEventListener('click', () => {
            const words = getSelectedWordsForPdf();
            if (!words) return;
            const quizItems = words.map((word, i) => `<li>${word.japanese}: _________________________</li>`).join('');
            const answerItems = words.map((word, i) => `<li>${word.english}</li>`).join('');
            const bodyContent = `<h2>問題用紙</h2><ol class="list-container">${quizItems}</ol><div class="answer-key"><h2>解答</h2><ol class="list-container">${answerItems}</ol></div>`;
            openPrintWindow(bodyContent, '重要語句テスト (英語を解答)');
            closeModal();
        });

        document.getElementById('download-ja-quiz-btn').addEventListener('click', () => {
            const words = getSelectedWordsForPdf();
            if (!words) return;
            const quizItems = words.map(word => `<li>${word.english}: _________________________</li>`).join('');
            const answerItems = words.map(word => `<li>${word.japanese}</li>`).join('');
            const bodyContent = `<h2>問題用紙</h2><ol class="list-container">${quizItems}</ol><div class="answer-key"><h2>解答</h2><ol class="list-container">${answerItems}</ol></div>`;
            openPrintWindow(bodyContent, '重要語句テスト (日本語を解答)');
            closeModal();
        });

        document.getElementById('download-mixed-quiz-btn').addEventListener('click', () => {
            const words = getSelectedWordsForPdf();
            if (!words) return;
            let quizItems = '';
            let answerItems = '';
            const shuffled = [...words].sort(() => 0.5 - Math.random());
            shuffled.forEach(word => {
                if (Math.random() > 0.5) {
                    quizItems += `<li>${word.japanese}: _________________________</li>`;
                    answerItems += `<li>${word.english}</li>`;
                } else {
                    quizItems += `<li>${word.english}: _________________________</li>`;
                    answerItems += `<li>${word.japanese}</li>`;
                }
            });
            const bodyContent = `<h2>問題用紙</h2><ol class="list-container">${quizItems}</ol><div class="answer-key"><h2>解答</h2><ol class="list-container">${answerItems}</ol></div>`;
            openPrintWindow(bodyContent, '重要語句テスト (混合)');
            closeModal();
        });

        document.getElementById('download-sentence-quiz-btn').addEventListener('click', async () => {
            const words = getSelectedWordsForPdf();
            if (!words) return;
            
            let quizItems = '';
            let answerItems = '';

            const wordsForQuiz = words.filter(w => w.sentence);
             if(wordsForQuiz.length === 0) {
                alert('選択された単語には、穴埋め問題を作成できる例文がありません。');
                return;
            }

            for(const word of wordsForQuiz) {
                const cleanPhrase = word.english
                    .replace(/\(.*\)|~|\?|\+|A to B|A as B|A as well as B|O from -ing|O to do/g, '') // O関連 削除
                    .replace(/ S' \+ V'| S \+ seem\(s\) \+ to do/g, '')
                    .replace(/\.\.\. that/g, '')
                    .replace(/\[.*?\]/g, '') // Fixed regex
                    .replace(/\bone's\b/g, '\\w+\'s')
                    .trim();
                
                const words = cleanPhrase.split(/[\s\/]+/);
                const firstWord = words[0];
                const blankRegex = new RegExp(`\\b${firstWord}(\\w*)?\\b`, 'gi');

                const blankedSentence = word.sentence.replace(blankRegex, '_______________');
                quizItems += `<li>${blankedSentence}<br>（ヒント: ${word.japanese}）</li>`;
                answerItems += `<li>${word.english}</li>`;
            }

            const bodyContent = `<h2>問題用紙</h2><ol>${quizItems}</ol><div class="answer-key"><h2>解答</h2><ol class="list-container">${answerItems}</ol></div>`;
            openPrintWindow(bodyContent, '重要語句テスト (例文穴埋め)');
            closeModal();
        });

        document.getElementById('download-sentence-mixed-quiz-btn').addEventListener('click', async () => {
            const words = getSelectedWordsForPdf();
            if (!words) return;
            
            const wordsForQuiz = words.filter(w => w.sentence && w.sentence_ja);
            if (wordsForQuiz.length === 0) {
                alert('選択された単語には、混合問題を作成できる例文がありません。');
                return;
            }
            
            let quizItems = '';
            let answerItems = '';
            const shuffled = [...wordsForQuiz].sort(() => 0.5 - Math.random());
            
            const instructionText = '英語を答える問題は文脈に従ってヒントをもとに英語を、日本語を答える問題は英文の下線部の部分を日本語に直しなさい。';
            const generalInstruction = `<p style="text-align: left; border: 1px solid #ccc; padding: 10px; margin-bottom: 20px;">${instructionText}</p>`;

            for(const word of shuffled) {
                const cleanPhrase = word.english
                    .replace(/\(.*\)|~|\?|\+|A to B|A as B|A as well as B|O from -ing|O to do/g, '') // O関連 削除
                    .replace(/ S' \+ V'| S \+ seem\(s\) \+ to do/g, '')
                    .replace(/\.\.\. that/g, '')
                    .replace(/\[.*?\]/g, '') // Fixed regex
                    .replace(/\bone's\b/g, '\\w+\'s')
                    .trim();
                
                const words = cleanPhrase.split(/[\s\/]+/);
                const firstWord = words[0];
                const wordRegex = new RegExp(`\\b${firstWord}(\\w*)?\\b`, 'gi');

                if (Math.random() > 0.5) {
                    const blankedSentence = word.sentence.replace(wordRegex, '_______________');
                    quizItems += `<li>${blankedSentence}<br>（ヒント: ${word.japanese}）</li>`;
                    answerItems += `<li>${word.english}</li>`;
                } else {
                    const underlinedSentence = word.sentence.replace(wordRegex, (match) => `<u>${match}</u>`);
                    quizItems += `<li>${underlinedSentence}<br>_________________________</li>`;
                    answerItems += `<li>${word.japanese}</li>`;
                }
            }
            
            const bodyContent = `<h2>問題用紙</h2>${generalInstruction}<ol>${quizItems}</ol><div class="answer-key"><h2>解答</h2><ol class="list-container">${answerItems}</ol></div>`;
            openPrintWindow(bodyContent, '重要語句テスト (例文混合)');
            closeModal();
        });


        prevBtn.addEventListener('click', () => {
            if (currentWordIndex > 0) {
                currentWordIndex--;
                updateLearningView();
            }
        });

        nextBtn.addEventListener('click', () => {
            if (currentWordIndex < selectedWords.length - 1) {
                currentWordIndex++;
                updateLearningView();
            }
        });
        
        document.getElementById('back-to-setup-btn').addEventListener('click', () => switchSection('setup'));
        
        startTestBtn.addEventListener('click', showTestOptions);

        document.getElementById('back-to-learning-btn').addEventListener('click', () => switchSection('learning'));
        document.getElementById('back-to-home-btn').addEventListener('click', () => {
             document.querySelectorAll('.word-checkbox').forEach(cb => cb.checked = false);
             switchSection('setup');
        });
        
        speakBtn.addEventListener('click', () => {
            const textToSpeak = englishText.innerHTML;
            speak(textToSpeak);
        });
        
        recordBtn.addEventListener('click', async () => {
            if (!recognition) {
                 alert("音声認識機能が初期化されていないか、ブラウザでサポートされていません。");
                return;
            }

            const isRecording = mediaRecorder && mediaRecorder.state === 'recording';

            if (isRecording) {
                mediaRecorder.stop();
            } else {
                try {
                    micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(micStream);
                    
                    mediaRecorder.onstart = () => {
                        audioChunks = [];
                        recordBtn.innerHTML = '<i id="mic-icon" class="fas fa-stop text-2xl"></i>';
                        recordBtn.classList.remove('btn-red', 'shadow-red-200');
                        recordBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600', 'text-white', 'shadow-yellow-200');
                        document.getElementById('mic-icon').classList.add('recording');
                        playRecordingBtn.disabled = true;
                        playRecordingBtn.classList.add('btn-disabled');
                        pronunciationFeedbackContainer.innerHTML = '<div class="flex items-center justify-center text-slate-400 py-2"><div class="animate-pulse mr-2">●</div> Listening...</div>';
                        pronunciationFeedbackContainer.className = 'mt-6';
                    };

                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = () => {
                        recognition.stop();
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        recordedAudioURL = URL.createObjectURL(audioBlob);
                        recordingPlayer.src = recordedAudioURL;

                        recordBtn.innerHTML = '<i id="mic-icon" class="fas fa-microphone text-2xl"></i>';
                        recordBtn.classList.add('btn-red', 'shadow-red-200');
                        recordBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600', 'text-white', 'shadow-yellow-200');
                        document.getElementById('mic-icon').classList.remove('recording');
                        
                        playRecordingBtn.disabled = false;
                        playRecordingBtn.classList.remove('btn-disabled');

                        if (micStream) {
                            micStream.getTracks().forEach(track => track.stop());
                        }
                    };
                    
                    mediaRecorder.start();
                    recognition.start();

                } catch (err) {
                    console.error("Microphone access error:", err);
                    alert("マイクへのアクセスが許可されませんでした。録音機能を使用するには、ブラウザの設定でマイクを許可してください。");
                }
            }
        });
        
        playRecordingBtn.addEventListener('click', () => {
            if (recordedAudioURL) {
                recordingPlayer.play();
            }
        });

        document.getElementById('abort-test-btn').addEventListener('click', () => switchSection('setup'));

        document.getElementById('next-question-btn').addEventListener('click', () => {
            currentQuestionIndex++;
            if (currentQuestionIndex < quizQuestions.length) {
                displayQuizQuestion();
            } else {
                showResults();
            }
        });

        document.getElementById('restart-btn').addEventListener('click', () => {
            // Reset
            document.getElementById('score-circle').style.strokeDashoffset = 283;
            document.querySelectorAll('.word-checkbox').forEach(cb => cb.checked = false);
            switchSection('setup');
        });

    </script>
</body>
</html>